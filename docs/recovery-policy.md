## Recovery Policy（2分チェック／3分打切り・層ごと再生成）

本ポリシーは、生成・実行の停滞を最小化し、再現性の高い復旧を自動化するための運用基準です。判断は 2 分チェック／3 分打切りを基本とし、層ごとの再生成を徹底します。

### 基本原則
- **2分チェック**: 実行状態と進捗を 2 分間隔で確認。停滞が見られる場合は即座に原因切り分け（I/O待ち、外部API待ち、ロック競合など）。
- **3分打切り**: 3 分（180 秒）を超えても改善がない場合は、当該タスクを打切り、直前の正常状態へロールバック。
- **層ごと再生成**: FE/BE/Infra/Docs など層（layer）単位で再生成を行い、影響範囲を限定。

### 自動復旧ロジック（概要）
`tools/recover.sh` を定期実行または手動実行し、`.lock_runtime` の更新時刻を監視して 180 秒超過を検知したら以下を実行します。

1. `git restore .`（未コミット変更の巻き戻し）
2. `git clean -fd`（未追跡ファイルの削除）
3. `git reset --hard`（HEAD を強制ロールバック）
4. 実行ログを `logs/local/recover.ndjson` に 1 行追記（毎回必ず 1 行増加）
5. `.lock_runtime` を更新（次チェック基準時刻のリセット）

### 手動実行コマンド例
```bash
# bash で直接実行
bash tools/recover.sh

# package スクリプトから実行
pnpm run recover
```

### 層ごと再生成の指針
1. 影響層を特定（例: `frontend` コンポーネントのみ、`backend` API のみ、ドキュメントのみ）。
2. 当該層に限定してロールバックと再生成を実行。
3. 生成後は差分検証（型チェック／lint／ビルド／アプリ起動）を実施し、正常性を確認。

### 注意事項
- ログファイルは NDJSON 形式（1 行 1 JSON）。監査・突合せに利用。
- Git 作業ツリー以外の外部アーティファクト（DB、キャッシュ、外部ストレージ）は対象外。別途プレイブックで扱う。
- Windows 環境では Git Bash 等の `bash` 実行環境を使用してください。

### 参考: 代表的な復旧コマンド
```bash
# 変更の巻き戻し（未コミット）
git restore .

# 未追跡ファイル/生成物の削除
git clean -fd

# HEAD を強制的に戻す
git reset --hard
```


